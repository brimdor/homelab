# https://github.com/bjw-s-labs/helm-charts/blob/main/charts/library/common/values.yaml
app-template:
  controllers:
    main:
      strategy: RollingUpdate
      replicas: 1
      containers:
        main:
          image:
            repository: ghcr.io/openclaw/openclaw
            tag: latest
            pullPolicy: Always
          env:
            TZ: "America/Chicago"
            HOME: "/home/node"
            TERM: "xterm-256color"
            OPENCLAW_GATEWAY_BIND: "lan"
            OPENCLAW_GATEWAY_PORT: "18789"
            OPENCLAW_GATEWAY_TRUSTED_PROXIES: "10.0.2.71"
            # Keep config + state on the persisted NFS mount.
            OPENCLAW_STATE_DIR: "/home/node/.openclaw"
            OPENCLAW_CONFIG_PATH: "/home/node/.openclaw/openclaw.json"
            OPENCLAW_GATEWAY_TOKEN:
              valueFrom:
                secretKeyRef:
                  name: "secrets"
                  key: "gateway-token"
            PATH: "/root/.bun/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/home/node/.openclaw/bin"
            OPENCLAW_CHANNELS_DISCORD_TOKEN:
              valueFrom:
                secretKeyRef:
                  name: "secrets"
                  key: "discord-token"
            OPENCLAW_CHANNELS_DISCORD_APPLICATION_ID:
              valueFrom:
                secretKeyRef:
                  name: "secrets"
                  key: "discord-application-id"
            OPENCLAW_CHANNELS_NOSTR_PRIVATE_KEY:
              valueFrom:
                secretKeyRef:
                  name: "secrets"
                  key: "nostr-private-key"
            OPENCLAW_CHANNELS_NOSTR_PUBLIC_KEY:
              valueFrom:
                secretKeyRef:
                  name: "secrets"
                  key: "nostr-public-key"
          command:
            - /bin/sh
            - -c
            - |
              set -e
              umask 077

              mkdir -p /home/node/libs
              npm install nostr-tools --no-save --prefix /home/node/libs
              ln -sf /home/node/libs/node_modules/nostr-tools /app/node_modules/nostr-tools

              mkdir -p /home/node/.openclaw /home/node/.openclaw/credentials /home/node/.openclaw/workspace
              rm -f /home/node/.openclaw/openclaw.json
              cp /config/openclaw.json /home/node/.openclaw/openclaw.json
              chmod 600 /home/node/.openclaw/openclaw.json
              chmod 700 /home/node/.openclaw /home/node/.openclaw/credentials /home/node/.openclaw/workspace || true

              # Patch bundled nostr plugin into persisted state so we can override
              # the bundled plugin without editing the container image.
              #
              # Fixes:
              # - nostr-tools SimplePool.subscribeMany signature (filter must be an object)
              # - OpenClaw outbound adapter check (sendMedia required today)
              EXT_ROOT="/home/node/.openclaw/extensions"
              NOSTR_DST="$EXT_ROOT/nostr"
              if [ ! -f "$NOSTR_DST/.patched-openclaw-nostr-dm" ]; then
                mkdir -p "$EXT_ROOT"
                rm -rf "$NOSTR_DST"
                cp -R /app/extensions/nostr "$NOSTR_DST"

                node - <<'NODE'
              const fs = require('node:fs');

              function replaceOnce(file, from, to) {
                const s = fs.readFileSync(file, 'utf8');
                if (s.includes(to)) return false;
                if (!s.includes(from)) throw new Error(`pattern not found in ${file}`);
                fs.writeFileSync(file, s.replace(from, to), 'utf8');
                return true;
              }

              // Fix nostr-tools SimplePool.subscribeMany signature (expects a single filter object, not an array).
              replaceOnce(
                '/home/node/.openclaw/extensions/nostr/src/nostr-bus.ts',
                'const sub = pool.subscribeMany(relays, [{ kinds: [4], "#p": [pk], since }], {',
                'const sub = pool.subscribeMany(relays, { kinds: [4], "#p": [pk], since }, {',
              );

              // OpenClaw core currently requires outbound.sendMedia even if channel media=false.
              // Provide a stub that errors clearly if ever invoked.
              replaceOnce(
                '/home/node/.openclaw/extensions/nostr/src/channel.ts',
                '  },\n\n  status:',
                '    sendMedia: async () => {\n      throw new Error("Nostr channel does not support media");\n    },\n  },\n\n  status:',
              );
              NODE

              touch "$NOSTR_DST/.patched-openclaw-nostr-dm"
              fi

              exec node dist/index.js gateway --bind lan --port 18789 --allow-unconfigured --verbose
          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /health
                  port: 18789
                initialDelaySeconds: 30
                periodSeconds: 10
            readiness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /health
                  port: 18789
                initialDelaySeconds: 10
                periodSeconds: 10
            startup:
              enabled: false
          resources:
            requests:
              cpu: 500m
              memory: "512Mi"
            limits:
              cpu: 2
              memory: "2048Mi"
  service:
    main:
      primary: true
      ports:
        http:
          port: 18789
          protocol: HTTP
        bridge:
          port: 18790
          protocol: TCP
  ingress:
    main:
      enabled: true
      className: nginx
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
        nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
        nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
        nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
        nginx.ingress.kubernetes.io/upstream-hash-by: "$remote_addr"
      hosts:
        - host: &Host openclaw.eaglepass.io
          paths:
            - path: /
              pathType: Prefix
              service:
                identifier: main
                port: 18789
      tls:
        - hosts:
            - *Host
          secretName: openclaw-tls-certificate
  persistence:
    data:
      type: nfs
      server: 10.0.40.3
      path: /mnt/user/openclaw
      advancedMounts:
        main:
          main:
            - path: /home/node/.openclaw

    searxng-skill:
      enabled: true
      type: configMap
      name: openclaw-searxng-skill
      items:
        - key: SKILL.md
          path: SKILL.md
    
    config:
      enabled: true
      type: configMap
      name: openclaw-config
      items:
        - key: openclaw.json
          path: openclaw.json
      advancedMounts:
        main:
          main:
            - path: /config/openclaw.json
              subPath: openclaw.json

  configMaps:
    config:
      enabled: true
      data:
        openclaw.json: |
          {
            "models": {
              "providers": {
                "ollama": {
                  "baseUrl": "http://ollama.ollama.svc.cluster.local:11434/v1",
                  "apiKey": "ollama",
                  "api": "openai-completions",
                  "models": [
                    {
                      "id": "Echo:latest",
                      "name": "Echo Latest",
                      "reasoning": true,
                      "input": ["text"],
                      "cost": { "input": 0, "output": 0, "cacheRead": 0, "cacheWrite": 0 },
                      "contextWindow": 131072,
                      "maxTokens": 8192
                    }
                  ]
                }
              }
            },
            "agents": {
              "defaults": {
                "model": { "primary": "ollama/Echo:latest" },
                "thinkingDefault": "off",
                "maxConcurrent": 4,
                "subagents": { "maxConcurrent": 8 },
                "workspace": "/home/node/.openclaw/workspace"
              },
              "list": [
                {
                  "id": "echo",
                  "model": "ollama/Echo:latest",
                  "identity": { "name": "Echo", "emoji": "ðŸ¤–" }
                }
              ]
            },
            "messages": { "ackReactionScope": "group-mentions" },
            "commands": { "native": "auto", "nativeSkills": "auto" },
            "hooks": {
              "internal": {
                "enabled": true,
                "entries": {
                  "boot-md": { "enabled": true },
                  "command-logger": { "enabled": true },
                  "session-memory": { "enabled": true }
                }
              }
            },
            "channels": {
              "discord": {
                "token": "${OPENCLAW_CHANNELS_DISCORD_TOKEN}",
                "enabled": true,
                "configWrites": false,
                "groupPolicy": "allowlist",
                "actions": {
                  "reactions": true,
                  "stickers": true,
                  "messages": true,
                  "threads": true,
                  "pins": true,
                  "search": true,
                  "channelInfo": true,
                  "channels": true
                },
                "dm": {
                  "enabled": true,
                  "policy": "open",
                  "allowFrom": ["*"]
                },
                "guilds": {
                  "925834781227368519": {
                    "channels": {
                      "1465363798499131566": { "allow": true }
                    }
                  }
                }
              },
              "nostr": {
                "enabled": true,
                "privateKey": "${OPENCLAW_CHANNELS_NOSTR_PRIVATE_KEY}",
                "publicKey": "${OPENCLAW_CHANNELS_NOSTR_PUBLIC_KEY}",
                "dmPolicy": "allowlist",
                "allowFrom": ["npub1g8ntsc97udpmhs322635vcc8rgcumh795l6mtvps23armcvcwevs3f44f7"],
                "relays": [
                  "wss://relay.damus.io",
                  "wss://relay.primal.net",
                  "wss://nos.lol"
                ]
              }
            },
            "gateway": {
              "port": 18789,
              "mode": "local",
              "bind": "lan",
              "trustedProxies": ["10.0.2.71"],
              "auth": { "mode": "token" },
              "tailscale": { "mode": "off", "resetOnExit": false }
            },
             "plugins": {
               "load": {
                 "paths": ["/home/node/.openclaw/extensions/nostr/index.ts"]
               },
               "entries": {
                 "discord": { "enabled": true },
                 "nostr": { "enabled": true }
               }
             },
            "auth": {
              "profiles": {
                "openai-codex:default": { "provider": "openai-codex", "mode": "oauth" }
              }
            },
            "skills": {
              "install": { "nodeManager": "npm" }
            },
            "browser": {
              "enabled": true,
              "evaluateEnabled": true
            },
            "tools": {
              "web": {
                "search": {
                  "enabled": true,
                  "provider": "brave"
                }
              }
            }
          }

    searxng-skill:
      enabled: true
      data:
        SKILL.md: |
          ---
          name: searxng
          description: Search the web via the homelab SearXNG instance.
          ---

          Use this skill when the user asks for web search but the built-in `web_search` tool is not available or has no API key, or when the user explicitly wants results from the homelab SearXNG.

          How to search:
          1) Form a concise query string from the user's request.
          2) Fetch JSON results from SearXNG using `web_fetch`:

             - Base URL: https://searxng.eaglepass.io
             - Endpoint: /search
             - Query params:
               - q: <query>
               - format: json

             Example URL (URL-encode q):
             https://searxng.eaglepass.io/search?q=<query>&format=json

          3) Parse the JSON and extract the best results (usually 5-8): title, url, and content/snippet.
          4) Answer with a short synthesis plus a list of citations (each citation should include title + URL).
          5) If the user asks for details from a specific result, use `web_fetch` on that result URL to retrieve and quote the relevant section.

          Notes:
          - Prefer `extractMode: "text"` for the SearXNG JSON response.
          - If the SearXNG request fails, fall back to `web_search` (if configured) or ask the user to confirm an alternative.
  defaultPodOptions:
    securityContext:
      fsGroup: 1000
    annotations:
      operator.1password.io/item-path: "vaults/4uaua4a45yuhnwhehp5bwylmti/items/2d2xphod42xwz2eoxs3tyyx7je"
      operator.1password.io/item-name: "secrets"
