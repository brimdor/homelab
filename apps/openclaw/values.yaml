# https://github.com/bjw-s-labs/helm-charts/blob/main/charts/library/common/values.yaml
app-template:
  controllers:
    main:
      strategy: RollingUpdate
      replicas: 1
      containers:
        main:
          image:
            repository: ghcr.io/openclaw/openclaw
            tag: latest
            pullPolicy: Always
          command: ["node", "dist/entry.js"]
          args:
            - gateway
            - --bind
            - lan
            - --port
            - "18789"
            - --verbose
          env:
            TZ: "America/Chicago"
            HOME: "/home/node"
            TERM: "xterm-256color"
            OPENCLAW_GATEWAY_BIND: "lan"
            OPENCLAW_GATEWAY_PORT: "18789"
            OPENCLAW_GATEWAY_TRUSTED_PROXIES: "10.0.7.72"
            OPENCLAW_MANAGED_SKILLS: "clawhub:WeAreAllSatoshiN/openclaw-mem"
            PATH: "/root/.bun/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/home/node/.openclaw/bin"
            OPENCLAW_STATE_DIR: "/home/node/.openclaw"
            OPENCLAW_CONFIG_PATH: "/home/node/.openclaw/openclaw.json"
            OPENCLAW_GATEWAY_TOKEN:
              valueFrom:
                secretKeyRef:
                  name: "secrets"
                  key: "gateway-token"
            OPENCLAW_CHANNELS_DISCORD_TOKEN:
              valueFrom:
                secretKeyRef:
                  name: "secrets"
                  key: "discord-token"
            OPENCLAW_CHANNELS_DISCORD_APPLICATION_ID:
              valueFrom:
                secretKeyRef:
                  name: "secrets"
                  key: "discord-application-id"
            NOSTR_PRIVATE_KEY:
              valueFrom:
                secretKeyRef:
                  name: "secrets"
                  key: "nostr-private-key"

          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /health
                  port: 18789
                initialDelaySeconds: 30
                periodSeconds: 10
            readiness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /health
                  port: 18789
                initialDelaySeconds: 10
                periodSeconds: 10
            startup:
              enabled: false
          resources:
            requests:
              cpu: 500m
              memory: "512Mi"
            limits:
              cpu: 2
              memory: "2048Mi"

        # Sidecar: WSS watchdog to monitor Nostr relay connectivity
        # When relays become unreachable, this sidecar's liveness probe fails,
        # causing Kubernetes to restart the entire pod (including the main container)
        wss-watchdog:
          image:
            repository: node
            tag: 20-alpine
            pullPolicy: IfNotPresent
          command:
            - sh
            - -c
            - |
              cp -a /opt/wss-checker /tmp/wss-checker || true
              cd /tmp/wss-checker || cd /opt/wss-checker
              npm install --production --silent || true
              node index.js
          env:
            RELAYS: "wss://relay.damus.io,wss://relay.snort.social"
            CHECK_INTERVAL: "15000"
            FAIL_THRESHOLD: "2"
            PORT: "8080"
          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /healthz
                  port: 8080
                initialDelaySeconds: 30
                periodSeconds: 20
                failureThreshold: 3
                timeoutSeconds: 5
            readiness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /healthz
                  port: 8080
                initialDelaySeconds: 10
                periodSeconds: 20
                failureThreshold: 3
                timeoutSeconds: 5
          resources:
            requests:
              cpu: 10m
              memory: "32Mi"
            limits:
              cpu: 100m
              memory: "128Mi"

      initContainers:
        config-check:
          image:
            repository: alpine
            tag: latest
            pullPolicy: Always
          env:
            OPENCLAW_CONFIG_PATH: "/home/node/.openclaw/openclaw.json"
            OPENCLAW_CONFIG_SHA256: "530ac0bae67facd9a5e4abfe3e125725b49e69f892423f79f02516dddd48d2ba"
          command:
            - /bin/sh
            - -c
            - |
              set -eu

              if [ ! -s "${OPENCLAW_CONFIG_PATH}" ]; then
                echo "[ERROR] Missing OpenClaw config: ${OPENCLAW_CONFIG_PATH}"
                echo "[ERROR] Populate it on the NFS share backing /home/node/.openclaw (server path: /mnt/user/openclaw/openclaw.json)"
                exit 1
              fi

              actual_sha="$(sha256sum "${OPENCLAW_CONFIG_PATH}" | cut -d ' ' -f1)"
              if [ "${actual_sha}" != "${OPENCLAW_CONFIG_SHA256}" ]; then
                echo "[ERROR] OpenClaw config checksum mismatch for ${OPENCLAW_CONFIG_PATH}"
                echo "[ERROR] expected=${OPENCLAW_CONFIG_SHA256} actual=${actual_sha}"
                exit 1
              fi

              echo "[INFO] OpenClaw config present and validated: ${OPENCLAW_CONFIG_PATH}"
  service:
    main:
      primary: true
      ports:
        http:
          port: 18789
          protocol: HTTP
        bridge:
          port: 18790
          protocol: TCP
  ingress:
    main:
      enabled: true
      className: nginx
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
        nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
        nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
        nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
        nginx.ingress.kubernetes.io/upstream-hash-by: "$remote_addr"
      hosts:
        - host: &Host openclaw.eaglepass.io
          paths:
            - path: /
              pathType: Prefix
              service:
                identifier: main
                port: 18789
      tls:
        - hosts:
            - *Host
          secretName: openclaw-tls-certificate
  persistence:
    data:
      type: nfs
      server: 10.0.40.3
      path: /mnt/user/openclaw
      advancedMounts:
        main:
          main:
            - path: /home/node/.openclaw
          config-check:
            - path: /home/node/.openclaw

    # Hide the incomplete bundled nostr extension (missing node_modules).
    # The properly installed plugin at /home/node/.openclaw/extensions/nostr is used instead.
    # See: https://docs.openclaw.ai/channels/nostr
    disable-bundled-nostr:
      enabled: true
      type: emptyDir
      advancedMounts:
        main:
          main:
            - path: /app/extensions/nostr

    # WSS checker code for the wss-watchdog sidecar
    wss-checker-code:
      enabled: true
      type: configMap
      name: openclaw-wss-checker
      advancedMounts:
        main:
          wss-watchdog:
            - path: /opt/wss-checker
              readOnly: true


  defaultPodOptions:
    securityContext:
      fsGroup: 1000
    annotations:
      operator.1password.io/item-path: "vaults/4uaua4a45yuhnwhehp5bwylmti/items/2d2xphod42xwz2eoxs3tyyx7je"
      operator.1password.io/item-name: "secrets"
