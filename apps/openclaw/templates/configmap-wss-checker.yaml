apiVersion: v1
kind: ConfigMap
metadata:
  name: openclaw-wss-checker
  namespace: {{ .Release.Namespace }}
data:
  index.js: |
    const WebSocket = require('ws');
    const express = require('express');

    const relays = (process.env.RELAYS || 'wss://relay.damus.io').split(',');
    const PORT = process.env.PORT || 8080;
    const CHECK_INTERVAL = parseInt(process.env.CHECK_INTERVAL || '15000', 10); // ms
    const FAIL_THRESHOLD = parseInt(process.env.FAIL_THRESHOLD || '2', 10);

    let lastSuccess = Date.now();
    let consecutiveFailures = 0;

    async function checkRelay(url) {
      return new Promise((resolve) => {
        const ws = new WebSocket(url, { handshakeTimeout: 5000 });
        let settled = false;
        const timer = setTimeout(() => {
          if (!settled) {
            settled = true;
            try { ws.terminate(); } catch (e) {}
            resolve(false);
          }
        }, 8000);

        ws.on('open', () => {
          if (settled) return;
          settled = true;
          clearTimeout(timer);
          try { ws.close(); } catch (e) {}
          resolve(true);
        });

        ws.on('error', () => {
          if (settled) return;
          settled = true;
          clearTimeout(timer);
          resolve(false);
        });
      });
    }

    async function checkAll() {
      for (const r of relays) {
        try {
          const ok = await checkRelay(r);
          if (ok) {
            lastSuccess = Date.now();
            consecutiveFailures = 0;
            return;
          }
        } catch (e) {
          // continue
        }
      }
      consecutiveFailures++;
    }

    setInterval(() => {
      checkAll().catch(() => {});
    }, CHECK_INTERVAL);

    // run an initial check
    checkAll().catch(() => {});

    const app = express();
    app.get('/healthz', (req, res) => {
      const age = Date.now() - lastSuccess;
      if (consecutiveFailures >= FAIL_THRESHOLD || age > CHECK_INTERVAL * FAIL_THRESHOLD) {
        return res.status(500).send('unhealthy');
      }
      res.status(200).send('ok');
    });

    app.get('/metrics', (req, res) => {
      res.set('Content-Type', 'text/plain');
      res.send(`# HELP openclaw_wss_last_success_ms Last success timestamp ms\nopenclaw_wss_last_success_ms ${lastSuccess}\n# HELP openclaw_wss_consecutive_failures Consecutive failures\nopenclaw_wss_consecutive_failures ${consecutiveFailures}\n`);
    });

    app.listen(PORT, () => {
      console.log('wss-checker listening on', PORT);
    });
  package.json: |
    {
      "name": "openclaw-wss-checker",
      "version": "0.1.0",
      "private": true,
      "dependencies": {
        "ws": "^8.13.0",
        "express": "^4.18.2"
      }
    }
