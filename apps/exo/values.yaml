# Exo - Distributed AI Cluster
# https://github.com/bjw-s-labs/helm-charts/blob/main/charts/library/common/values.yaml
# Using app-template v4.5.0 schema

app-template:
  controllers:
    main:
      # Adjust replicas to match your node count for multi-device AI cluster
      replicas: 4
      strategy: RollingUpdate
      containers:
        main:
          image:
            # Build and push your own image using the Dockerfile in this directory
            # docker build -t brimdor/exo:latest .
            # docker push brimdor/exo:latest
            repository: docker.io/brimdor/exo
            tag: latest
            pullPolicy: Always
          args:
            - "--api-port"
            - "52415"
          env:
            TZ: "America/Chicago"
            PUID: "1000"
            PGID: "1000"
            # DNS-based peer discovery for Kubernetes
            # This enables pods to discover each other via headless service DNS
            EXO_DISCOVERY_MODE: "dns"
            EXO_DNS_HOSTNAME: "exo-headless.exo.svc.cluster.local"
            EXO_DNS_PORT: "52414"
            EXO_DNS_POLL_INTERVAL: "5"
            # Fixed libp2p port for peer-to-peer communication (required for DNS discovery)
            EXO_LIBP2P_PORT: "52414"
          probes:
            liveness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /
                  port: 52415
                initialDelaySeconds: 120
                periodSeconds: 30
                timeoutSeconds: 10
                failureThreshold: 3
            readiness:
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /
                  port: 52415
                initialDelaySeconds: 60
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 3
            startup:
              enabled: true
              custom: true
              spec:
                httpGet:
                  path: /
                  port: 52415
                initialDelaySeconds: 30
                periodSeconds: 10
                timeoutSeconds: 5
                failureThreshold: 30

  service:
    main:
      controller: main
      ports:
        http:
          port: 52415
          protocol: HTTP
    # Headless service for peer discovery via DNS
    headless:
      controller: main
      type: ClusterIP
      clusterIP: None
      ports:
        http:
          port: 52415
          protocol: TCP
        libp2p:
          port: 52414
          protocol: TCP

  ingress:
    main:
      enabled: true
      className: nginx
      annotations:
        external-dns.alpha.kubernetes.io/target: "homelab-tunnel.eaglepass.io"
        external-dns.alpha.kubernetes.io/cloudflare-proxied: "true"
        cert-manager.io/cluster-issuer: letsencrypt-prod
      hosts:
        - host: exo.eaglepass.io
          paths:
            - path: /
              pathType: Prefix
              service:
                identifier: main
                port: http
      tls:
        - hosts:
            - exo.eaglepass.io
          secretName: exo-tls-certificate

  persistence:
    data:
      type: nfs
      server: 10.0.40.3
      path: /mnt/user/exo
      advancedMounts:
        main:
          main:
            - path: /data/models

  defaultPodOptions:
    annotations:
    # Ensure each pod runs on a different node for distributed AI cluster
    affinity:
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - exo
            topologyKey: kubernetes.io/hostname
