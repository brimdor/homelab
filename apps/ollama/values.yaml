app-template:
  controllers:
    main:
      containers:
        main:
          image:
            repository: docker.io/ollama/ollama
            tag: 0.6.3
    ui:
      containers:
        main:
          image:
            repository: ghcr.io/open-webui/open-webui
            tag: latest
          env:
            OLLAMA_BASE_URL: http://ollama:11434
          cronjobs:
            - name: backup
              schedule: "*/10 * * * *" # Every 10 minutes
              command:
                - /bin/sh
                - -c
                - |
                  tar -czf /mnt/backup/backup-$(date +\%Y\%m\%d\%H\%M\%S).tar.gz /app/backend/data && \
                  touch /tmp/bees-knees
              volumeMounts:
                - name: nfs-backup
                  mountPath: /mnt/backup
      initContainers:
        - name: restore
          image: alpine:latest
          command:
            - /bin/sh
            - -c
            - |
              if [ ! -f /tmp/bees-knees ]; then
                latest_backup=$(ls -t /mnt/backup/backup-*.tar.gz | head -n 1) && \
                tar -xzf $latest_backup -C /app/backend/data
              fi
          volumeMounts:
            - name: nfs-backup
              mountPath: /mnt/backup
            - name: ui-data
              mountPath: /app/backend/data
  service:
    main:
      ports:
        http:
          port: 11434
          protocol: HTTP
    ui:
      controller: ui
      ports:
        http:
          port: 8080
          protocol: HTTP
  ingress:
    main:
      enabled: true
      className: nginx
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
      hosts:
        - host: &ollamaHost ollama.eaglepass.io
          paths:
            - path: /
              pathType: Prefix
              service:
                name: main
                port: http
        - host: &uiHost ai.eaglepass.io
          paths:
            - path: /
              pathType: Prefix
              service:
                name: ui
                port: http
      tls:
        - hosts:
            - *ollamaHost
            - *uiHost
          secretName: ollama-tls-certificate
  persistence:
    data:
      # type: nfs
      # server: 10.0.50.3
      # path: /mnt/user/ollama-main
      type: pvc
      accessMode: ReadWriteOnce
      size: 150Gi
      advancedMounts:
        main:
          main:
            - path: /root/.ollama
    ui:
      type: pvc
      accessMode: ReadWriteMany
      size: 10Gi
      advancedMounts:
        ui:
          main:
            - path: /app/backend/data
  volumes:
    nfs-backup:
      type: nfs
      server: 10.0.50.3
      path: /mnt/user/ollama-ui
    ui-data:
      type: pvc
      accessMode: ReadWriteMany
      size: 10Gi
