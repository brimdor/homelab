app-template:
  controllers:
    main:
      containers:
        main:
          image:
            repository: docker.io/ollama/ollama
            tag: 0.6.3
    ui:
      containers:
        main:
          image:
            repository: ghcr.io/open-webui/open-webui
            tag: latest
          env:
            OLLAMA_BASE_URL: http://ollama:11434
          command:
            - /bin/sh
            - -c
            - |
              ls /app && \
              chmod +x /app/start.sh && \
              mkdir -p /mnt/backup && \
              (while true; do
                tar -czf /mnt/backup/backup-$(date +\%Y\%m\%d\%H\%M\%S).tar.gz /app/backend/data && \
                touch /app/backend/data/bees-knees
                sleep 600 # Run every 10 minutes
              done) & \
              ./app/start.sh
          volumeMounts:
            - name: nfs-backup
              mountPath: /mnt/backup
            - name: ui-data
              mountPath: /app/backend/data
        # backup:
        #   image: 
        #     repository: alpine
        #     tag: latest
        #   name: backup
        #   command:
        #     - /bin/sh
        #     - -c
        #     - |
        #       while true; do
        #         tar -czf /mnt/backup/backup-$(date +\%Y\%m\%d\%H\%M\%S).tar.gz /app/backend/data && \
        #         touch /app/backend/data/bees-knees
        #         sleep 600 # Run every 10 minutes
        #       done
          # volumeMounts:
          #   - name: nfs-backup
          #     mountPath: /mnt/backup
            # - name: ui-data
            #   mountPath: /app/backend/data
      initContainers:
        restore:
          image:
            repository: alpine
            tag: latest
          command:
            - /bin/sh
            - -c
            - |
              if [ ! -f /app/backend/data/bees-knees ]; then
                latest_backup=$(ls -t /mnt/backup/backup-*.tar.gz 2>/dev/null | head -n 1)
                if [ -n "$latest_backup" ]; then
                  echo "Restoring from backup: $latest_backup"
                  tar -xzf $latest_backup -C /app/backend/data
                  touch /app/backend/data/bees-knees
                else
                  echo "No backup found. Skipping restore."
                fi
              else
                echo "Restore skipped. Bees-knees file exists."
              fi
          volumeMounts:
            - name: nfs-backup
              mountPath: /mnt/backup
            - name: ui-data
              mountPath: /app/backend/data
  service:
    main:
      ports:
        http:
          port: 11434
          protocol: HTTP
    ui:
      controller: ui
      ports:
        http:
          port: 8080
          protocol: HTTP
  ingress:
    main:
      enabled: true
      className: nginx
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
      hosts:
        - host: &ollamaHost ollama.eaglepass.io
          paths:
            - path: /
              pathType: Prefix
              service:
                name: main
                port: http
        - host: &uiHost ai.eaglepass.io
          paths:
            - path: /
              pathType: Prefix
              service:
                name: ui
                port: http
      tls:
        - hosts:
            - *ollamaHost
            - *uiHost
          secretName: ollama-tls-certificate
  persistence:
    data:
      # type: nfs
      # server: 10.0.50.3
      # path: /mnt/user/ollama-main
      accessMode: ReadWriteOnce
      size: 150Gi
      advancedMounts:
        main:
          main:
            - path: /root/.ollama
    ui:
      accessMode: ReadWriteOnce
      size: 10Gi
      advancedMounts:
        ui:
          main:
            - path: /app/backend/data
  volumes:
    nfs-backup:
      type: nfs
      server: 10.0.50.3
      path: /mnt/user/ollama-ui
    ui-data:
      accessMode: ReadWriteOnce
      size: 10Gi