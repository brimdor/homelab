description = "Workflow to generate deployment-ready Helm charts for homelab apps"
sync_locations = [
  ".agent/workflows/build_charts.md",
  ".opencode/command/build_charts.md",
  ".gemini/commands/build_charts.toml"
]

prompt = '''

## User Input

```text
$ARGUMENTS
```

You **MUST** consider the user input before proceeding (if not empty).

The text the user typed after the command **is** the primary input:
- **App Name**: Official application name (canonical).
- **Repo URL**: GitHub repository or official documentation URL.

---

# Build Charts Workflow

## Overview
This workflow defines the rigorous process to generate **exactly two files** (`Chart.yaml` and `values.yaml`) for a given open-source application. It follows a Spec-Driven Development approach to ensure reliability, security, and immediate deployability in the homelab.

> [!IMPORTANT]
> **Sync Requirement**: This workflow exists in multiple locations that must stay synchronized:
> - `.agent/workflows/build_charts.md`
> - `.opencode/command/build_charts.md`
> - `.gemini/commands/build_charts.toml`
>
> When updating this file, **always copy changes to all locations**.

## Reference URLs (Authoritative)

- **bjw-s Helm Charts:** https://github.com/bjw-s-labs/helm-charts
  - Values: https://github.com/bjw-s-labs/helm-charts/blob/main/charts/library/common/values.yaml
- **ArtifactHub:** https://artifacthub.io/
- **1Password Operator:** https://github.com/1Password/onepassword-operator
- **Helm Dependencies:** https://helm.sh/docs/topics/charts/#chart-dependencies
- **Ingress Spec:** https://kubernetes.io/docs/concepts/services-networking/ingress/

---

## Phase 1: Context & Discovery

**Objective**: Gather all necessary information to drive the chart generation.

1.  **Parse User Input**:
    -   **Scenario A: Inputs Provided**
        -   Identify `<app-name>`: Must be **lowercase**, **single word or hyphenated** (e.g., `photo-view`, `nextcloud`).
        -   Identify Repository/Docs URL.
    -   **Scenario B: Inputs Missing (Interactive Mode)**
        -   If `Repo URL` is missing: **Ask the user for the Repository URL.**
        -   If `App Name` is missing (after getting URL):
            1.  Analyze the Repo URL to derive **3 valid name suggestions** (lowercase, hyphenated).
            2.  Present specific options to the user:
                -   1: `[Suggestion 1]`
                -   2: `[Suggestion 2]`
                -   3: `[Suggestion 3]`
                -   4: **Provide custom name**
            3.  **Wait** for the user to select an option or provide a custom name.
            4.  Proceed only once a valid `<app-name>` is confirmed.

2.  **External Discovery**:
    -   Search **ArtifactHub** and the application's official documentation.
    -   Identify if an **official** or thoroughly compliant **community** Helm chart exists.
    -   Locate `docker-compose.yml` in the source repo to understand:
        -   Container Image & Tag
        -   Environment Variables (Standard vs. Sensitive)
        -   Ports
        -   Volumes/Mount points

---

## Phase 2: Source Strategy

**Objective**: Select the correct architectural approach for `Chart.yaml`.

**Selection Algorithm**:

1.  **Primary Path: Official Chart**
    -   **Condition**: A reputable, well-maintained official chart exists.
    -   **Action**: Use it as a dependency in `Chart.yaml`.

2.  **Fallback Path: bjw-s app-template**
    -   **Condition**: No official chart exists, or it is stale/low-quality.
    -   **Action**: Use the **bjw-s app-template** library chart as a dependency.

> [!IMPORTANT]
> The chosen source strictly dictates the schema of `values.yaml`. Do NOT mix schemas.

---

## Phase 3: Specification

**Objective**: Define the specific configurations for Secrets, Storage, and Ingress.

### 3.1 Secrets Management (Mandatory)
All sensitive data must be retrieved via **1Password Operator**.

1.  **Pod Annotations**:
    ```yaml
    annotations:
      operator.1password.io/item-path: "vaults/<vaultID>/items/<itemID>"
      operator.1password.io/item-name: "secrets"
    ```
2.  **Environment Variables**:
    -   **Sensitive**: Use `valueFrom.secretKeyRef` sourcing from the `secrets` Secret.
    -   **Non-sensitive** (TZ, PUID): Use strict literal values.

### 3.2 Storage Configuration
Select based on data type:

-   **Type A: NFS (Long-term/Large Data)**
    -   Use for NAS persistence.
    -   Server: `10.0.50.3`
    -   Path: `/mnt/user/<app-name>`
-   **Type B: PVC (Fast Local/Cache)**
    -   Use `ReadWriteOnce`.
    -   **bjw-s Rule**: First PVC key must be `data`.

### 3.3 Network Access
-   **Ingress**:
    -   Host: `**<app-name>.eaglepass.io**`
    -   Class: Cluster default (e.g., `nginx`).
    -   TLS: Enabled via cert-manager.
-   **Service**:
    -   Prefer `ClusterIP`.
    -   Map container ports correctly.

---

## Phase 4: Implementation

**Objective**: Generate the final artifact files.

### 4.1 Global Output Rules
-   Generate **only** these two files.
-   No placeholders (resolve all IDs, paths, versions).
-   No comments unless critical for maintenance.

### 4.2 File Generation - `apps/<app-name>/Chart.yaml`
-   **Dependencies**: Explicitly list the chosen chart from Phase 2 with a pinned `version`.
-   **Metadata**: `apiVersion: v2`, `type: application`, `version: 0.1.0`.

### 4.3 File Generation - `apps/<app-name>/values.yaml`

**Scenario A: using Official Chart**
-   Configure **only** keys present in the official chart's `values.yaml`.
-   Inject secrets via `extraEnv` or `podAnnotations` as supported by the chart.

**Scenario B: using bjw-s app-template**
-   Structure:
    -   `controllers.main`: Image, replicas, env, 1Password annotations.
    -   `service.main`: Ports.
    -   `ingress.main`: Host, TLS.
    -   `persistence.data`: NFS or PVC.
-   Follow strict bjw-s schema.

---

## Phase 5: Verification

**Objective**: Final quality assurance checklist.

**Pass Criteria**:
1.  [ ] **File Count**: Exactly 2 files (`Chart.yaml`, `values.yaml`).
2.  [ ] **Dependency**: Valid versioned dependency in `Chart.yaml`.
3.  [ ] **Secrets**: 1Password annotations present; NO plain-text secrets; all sensitive envs use `secretKeyRef`.
4.  [ ] **Storage**: Correct `nfs` or `pvc` definition; paths match container requirements.
5.  [ ] **Ingress**: Host matches `<app-name>.eaglepass.io`; TLS enabled.
6.  [ ] **Schema**: All keys in `values.yaml` are valid for the chosen dependency.
7.  [ ] **Completeness**: No placeholders (`<...>`) remain.
8.  [ ] **Lint**: Files would pass `helm lint`.

If validation fails, return to **Phase 3** or **Phase 4** to correct.
'''
